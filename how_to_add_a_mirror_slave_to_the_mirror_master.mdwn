This will be of interest only to admins who run a Libravatar master server using the <tt>libravatar-master</tt> package and who want to add a new slave.

# Initial setup

Do this on the **slave**:

1. make sure NTP is installed and running
1. install the required packages on the slave:

        dpkg -i libravatar-{common,cdn-common,cdn,seccdn,slave}*.deb
        apt-get install -f

2. copy the SSL certificate into place:

        cp seccdn-chain.pem /etc/libravatar/
        cp seccdn.pem /etc/libravatar/
        cp seccdn.crt /etc/libravatar/

3. make sure cron errors go somewhere by adding this to `/etc/aliases`:

        libravatar-slave: root

4. update the postfix config:

        newaliases
        /etc/init.d/postfix reload

Do this on the **master**:

1. add the slave's ssh pubkey to `/var/lib/libravatar/master/.ssh/authorized_keys`:

Within about 15 minutes, you should see these files pop up on the slave:

* <tt>/var/lib/libravatar/slave/cert/chain.pem</tt>
* <tt>/var/lib/libravatar/slave/cert/seccdn.pem</tt>
* <tt>/var/lib/libravatar/slave/cert/seccdn.crt</tt>

# Testing the new mirror

Given a new slave with an IP address of 192.0.2.10, then you can put this in your local <tt>/etc/hosts</tt>:

    192.0.2.10    cdn.libravatar.org seccdn.libravatar.org

and then lookup images using the [test tool](https://www.libravatar.org/tools/check).

# Adding the new mirror to the DNS load-balancer

1. Add these two DNS records in the <tt>libravatar.org</tt> zone:

        cdn      A    10   123.123.123.123
        seccdn   A    10   123.123.123.123
        cdn      AAAA 10   dead::beef
        seccdn   AAAA 10   dead::beef

2. Add the same records to the [JSON zone file](https://gitorious.org/libravatar/libravatar/blobs/master/config/dns.json) and then use <tt>namecoind</tt> to update the <tt>libravatar.bit</tt> zone:

        namecoind name_update d/libravatar "`xargs echo < config/dns.json`"


# SSL testing

Once the DNS zone has been updated, use the [SSL Labs tool](https://www.ssllabs.com/ssltest/analyze.html?d=seccdn.libravatar.org&hideResults=on) to make sure that the SSL config for the new mirror matches the other ones. In particular, it is important that the new mirror does not require the use of [SNI](https://en.wikipedia.org/wiki/Server_Name_Indication) since it's not supported on [old operating systems](https://en.wikipedia.org/wiki/Windows_XP).

If there are any problems, simply take the new mirror out of the `seccdn` CNAME group. The bandwidth requirements for HTTP are much bigger, so it's fine to have fewer mirrors doing HTTPS.

# Basic monitoring

At the very least, add something like <http://ismyblogworking.com/1.cdn.libravatar.org/working.html> to your feed reader.

# Enabling stats on the slave (optional)

1. install awstats:

        apt-get install awstats

2. add this to <tt>/etc/awstats/awstats.conf.local</tt>:

        SiteDomain="libravatar.org"
        LogType=W
        LogFormat=1

3. make the reports available:

        ln -s /usr/share/awstats/icon/ /var/www/awstats-icon
        ln -s /var/cache/awstats/ /var/www/stats
